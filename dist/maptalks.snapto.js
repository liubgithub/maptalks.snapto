!function(t,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports,require("maptalks")):"function"==typeof define&&define.amd?define(["exports","maptalks"],n):n(t.maptalks=t.maptalks||{},t.maptalks)}(this,function(t,u){"use strict";function e(t,n){return(e=Object.setPrototypeOf||function(t,n){return t.__proto__=n,t})(t,n)}var h=(function(t){function d(t,n,i){var r=t[n];t[n]=t[i],t[i]=r}function o(t,n){return t<n?-1:n<t?1:0}t.exports=function(t,n,i,r,e){!function t(n,i,r,e,o){for(;r<e;){var s,u,h,a,c;600<e-r&&(s=e-r+1,u=i-r+1,a=Math.log(s),h=.5*Math.exp(2*a/3),c=.5*Math.sqrt(a*h*(s-h)/s)*(u-s/2<0?-1:1),a=Math.max(r,Math.floor(i-u*h/s+c)),c=Math.min(e,Math.floor(i+(s-u)*h/s+c)),t(n,i,a,c,o));var f=n[i],l=r,v=e;for(d(n,r,i),0<o(n[e],f)&&d(n,r,e);l<v;){for(d(n,l,v),l++,v--;o(n[l],f)<0;)l++;for(;0<o(n[v],f);)v--}0===o(n[r],f)?d(n,r,v):d(n,++v,e),v<=i&&(r=v+1),i<=v&&(e=v-1)}}(t,n,i||0,r||t.length-1,e||o)}}(n={exports:{}}),n.exports),o=i,n=i;function i(t,n){if(!(this instanceof i))return new i(t,n);this.t=Math.max(4,t||9),this.n=Math.max(2,Math.ceil(.4*this.t)),n&&this.i(n),this.clear()}function v(t,n){d(t,0,t.children.length,n,t)}function d(t,n,i,r,e){(e=e||m(null)).minX=1/0,e.minY=1/0,e.maxX=-1/0,e.maxY=-1/0;for(var o,s=n;s<i;s++)o=t.children[s],c(e,t.leaf?r(o):o);return e}function c(t,n){return t.minX=Math.min(t.minX,n.minX),t.minY=Math.min(t.minY,n.minY),t.maxX=Math.max(t.maxX,n.maxX),t.maxY=Math.max(t.maxY,n.maxY),t}function s(t,n){return t.minX-n.minX}function a(t,n){return t.minY-n.minY}function y(t){return(t.maxX-t.minX)*(t.maxY-t.minY)}function f(t){return t.maxX-t.minX+(t.maxY-t.minY)}function l(t,n){return t.minX<=n.minX&&t.minY<=n.minY&&n.maxX<=t.maxX&&n.maxY<=t.maxY}function p(t,n){return n.minX<=t.maxX&&n.minY<=t.maxY&&n.maxX>=t.minX&&n.maxY>=t.minY}function m(t){return{children:t,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function w(t,n,i,r,e){for(var o,s=[n,i];s.length;)(i=s.pop())-(n=s.pop())<=r||(o=n+Math.ceil((i-n)/r/2)*r,h(t,o,n,i,e),s.push(n,o,o,i))}function b(t,n,i){if(null!==t)for(var r,e,o,s,u,h,a,c=0,f=t.type,l="FeatureCollection"===f,v="Feature"===f,d=l?t.features.length:1,y=0;y<d;y++)for(u=(a=!!(h=l?t.features[y].geometry:v?t.geometry:t)&&"GeometryCollection"===h.type)?h.geometries.length:1,r=0;r<u;r++){var p,m=0;if(null!==(p=a?h.geometries[r]:h)){var w=p.coordinates,M=p.type,g=!i||"Polygon"!==M&&"MultiPolygon"!==M?0:1;switch(M){case null:break;case"Point":n(w,c,y,m),c++,m++;break;case"LineString":case"MultiPoint":for(e=0;e<w.length;e++)n(w[e],c,y,m),c++,"MultiPoint"===M&&m++;"LineString"===M&&m++;break;case"Polygon":case"MultiLineString":for(e=0;e<w.length;e++){for(o=0;o<w[e].length-g;o++)n(w[e][o],c,y,m),c++;"MultiLineString"===M&&m++}"Polygon"===M&&m++;break;case"MultiPolygon":for(e=0;e<w.length;e++){for(o=0;o<w[e].length;o++)for(s=0;s<w[e][o].length-g;s++)n(w[e][o][s],c,y,m),c++;m++}break;case"GeometryCollection":for(e=0;e<p.geometries.length;e++)b(p.geometries[e],n,i);break;default:throw new Error("Unknown Geometry Type")}}}}function M(t,e,o,n){var s=o;return b(t,function(t,n,i,r){s=0===n&&void 0===o?t:e(s,t,n,i,r)},n),s}function g(t,n){var i;switch(t.type){case"FeatureCollection":for(i=0;i<t.features.length;i++)n(t.features[i].properties,i);break;case"Feature":n(t.properties,0)}}function P(t,n){if("Feature"===t.type)n(t,0);else if("FeatureCollection"===t.type)for(var i=0;i<t.features.length;i++)n(t.features[i],i)}function x(t,n){for(var i,r,e,o,s,u,h,a=0,c="FeatureCollection"===t.type,f="Feature"===t.type,l=c?t.features.length:1,v=0;v<l;v++){for(s=c?t.features[v].geometry:f?t.geometry:t,h=c?t.features[v].properties:f?t.properties:{},o=(u=!!s&&"GeometryCollection"===s.type)?s.geometries.length:1,r=0;r<o;r++)if(null!==(e=u?s.geometries[r]:s))switch(e.type){case"Point":case"LineString":case"MultiPoint":case"Polygon":case"MultiLineString":case"MultiPolygon":n(e,a,h);break;case"GeometryCollection":for(i=0;i<e.geometries.length;i++)n(e.geometries[i],a,h);break;default:throw new Error("Unknown Geometry Type")}else n(null,a,h);a++}}function k(t,o){x(t,function(t,i,r){var e,n=null===t?null:t.type;switch(n){case null:case"Point":case"LineString":case"Polygon":return void o(E(t,r),i,0)}switch(n){case"MultiPoint":e="Point";break;case"MultiLineString":e="LineString";break;case"MultiPolygon":e="Polygon"}t.coordinates.forEach(function(t,n){o(E({type:e,coordinates:t},r),i,n)})})}function r(t,s){k(t,function(i,r,e){var t,o=0;!i.geometry||"Point"!==(t=i.geometry.type)&&"MultiPoint"!==t&&M(i,function(t,n){t=C([t,n],i.properties);return s(t,r,e,o),o++,n})})}function E(t,n){if(void 0===t)throw new Error("No geometry passed");return{type:"Feature",properties:n||{},geometry:t}}function C(t,n){if(!t)throw new Error("No coordinates passed");if(t.length<2)throw new Error("Coordinates must be an array of two or more positions");return{type:"Feature",properties:n||{},geometry:{type:"LineString",coordinates:t}}}function F(t,n){if(!t)throw new Error("geojson is required");var i=(t.geometry||t).type;if(!i)throw new Error("invalid geojson");if("FeatureCollection"===i)throw new Error("FeatureCollection is not supported");if("GeometryCollection"===i)throw new Error("GeometryCollection is not supported");var r=(t.geometry||t).coordinates;if(!r)throw new Error("geojson must contain coordinates");switch(i){case"LineString":return void n(r,0,0);case"Polygon":case"MultiLineString":for(var e=0,o=0;o<r.length;o++)"MultiLineString"===i&&(e=o),n(r[o],o,e);return;case"MultiPolygon":for(var s=0;s<r.length;s++)for(var u=0;u<r[s].length;u++)n(r[s][u],u,s);return;default:throw new Error(i+" geometry not supported")}}i.prototype={all:function(){return this.r(this.data,[])},search:function(t){var n=this.data,i=[],r=this.toBBox;if(!p(t,n))return i;for(var e,o,s,u,h=[];n;){for(e=0,o=n.children.length;e<o;e++)s=n.children[e],p(t,u=n.leaf?r(s):s)&&(n.leaf?i.push(s):l(t,u)?this.r(s,i):h.push(s));n=h.pop()}return i},collides:function(t){var n=this.data,i=this.toBBox;if(!p(t,n))return!1;for(var r,e,o,s,u=[];n;){for(r=0,e=n.children.length;r<e;r++)if(o=n.children[r],p(t,s=n.leaf?i(o):o)){if(n.leaf||l(t,s))return!0;u.push(o)}n=u.pop()}return!1},load:function(t){if(!t||!t.length)return this;if(t.length<this.n){for(var n=0,i=t.length;n<i;n++)this.insert(t[n]);return this}var r,e=this.e(t.slice(),0,t.length-1,0);return this.data.children.length?this.data.height===e.height?this.o(this.data,e):(this.data.height<e.height&&(r=this.data,this.data=e,e=r),this.s(e,this.data.height-e.height-1,!0)):this.data=e,this},insert:function(t){return t&&this.s(t,this.data.height-1),this},clear:function(){return this.data=m([]),this},remove:function(t,n){if(!t)return this;for(var i,r,e,o,s=this.data,u=this.toBBox(t),h=[],a=[];s||h.length;){if(s||(s=h.pop(),r=h[h.length-1],i=a.pop(),o=!0),s.leaf&&-1!==(e=function(t,n,i){if(!i)return n.indexOf(t);for(var r=0;r<n.length;r++)if(i(t,n[r]))return r;return-1}(t,s.children,n)))return s.children.splice(e,1),h.push(s),this.u(h),this;o||s.leaf||!l(s,u)?r?(i++,s=r.children[i],o=!1):s=null:(h.push(s),a.push(i),s=(r=s).children[i=0])}return this},toBBox:function(t){return t},compareMinX:s,compareMinY:a,toJSON:function(){return this.data},fromJSON:function(t){return this.data=t,this},r:function(t,n){for(var i=[];t;)t.leaf?n.push.apply(n,t.children):i.push.apply(i,t.children),t=i.pop();return n},e:function(t,n,i,r){var e,o=i-n+1,s=this.t;if(o<=s)return v(e=m(t.slice(n,i+1)),this.toBBox),e;r||(r=Math.ceil(Math.log(o)/Math.log(s)),s=Math.ceil(o/Math.pow(s,r-1))),(e=m([])).leaf=!1,e.height=r;var u,h,a,c,f=Math.ceil(o/s),l=f*Math.ceil(Math.sqrt(s));for(w(t,n,i,l,this.compareMinX),u=n;u<=i;u+=l)for(w(t,u,a=Math.min(u+l-1,i),f,this.compareMinY),h=u;h<=a;h+=f)c=Math.min(h+f-1,a),e.children.push(this.e(t,h,c,r-1));return v(e,this.toBBox),e},h:function(t,n,i,r){for(var e,o,s,u,h,a,c,f,l;;){if(r.push(n),n.leaf||r.length-1===i)break;for(a=c=1/0,e=0,o=n.children.length;e<o;e++)h=y(s=n.children[e]),f=t,l=s,(f=(Math.max(l.maxX,f.maxX)-Math.min(l.minX,f.minX))*(Math.max(l.maxY,f.maxY)-Math.min(l.minY,f.minY))-h)<c?(c=f,a=h<a?h:a,u=s):f===c&&h<a&&(a=h,u=s);n=u||n.children[0]}return n},s:function(t,n,i){var r=this.toBBox,i=i?t:r(t),e=[],r=this.h(i,this.data,n,e);for(r.children.push(t),c(r,i);0<=n&&e[n].children.length>this.t;)this.a(e,n),n--;this.c(i,e,n)},a:function(t,n){var i=t[n],r=i.children.length,e=this.n;this.f(i,e,r);r=this.l(i,e,r),r=m(i.children.splice(r,i.children.length-r));r.height=i.height,r.leaf=i.leaf,v(i,this.toBBox),v(r,this.toBBox),n?t[n-1].children.push(r):this.o(i,r)},o:function(t,n){this.data=m([t,n]),this.data.height=t.height+1,this.data.leaf=!1,v(this.data,this.toBBox)},l:function(t,n,i){for(var r,e,o,s,u,h,a,c,f,l=o=1/0,v=n;v<=i-n;v++)r=d(t,0,v,this.toBBox),e=d(t,v,i,this.toBBox),u=r,h=e,f=c=a=void 0,a=Math.max(u.minX,h.minX),c=Math.max(u.minY,h.minY),f=Math.min(u.maxX,h.maxX),h=Math.min(u.maxY,h.maxY),c=Math.max(0,f-a)*Math.max(0,h-c),e=y(r)+y(e),c<l?(l=c,s=v,o=e<o?e:o):c===l&&e<o&&(o=e,s=v);return s},f:function(t,n,i){var r=t.leaf?this.compareMinX:s,e=t.leaf?this.compareMinY:a;this.v(t,n,i,r)<this.v(t,n,i,e)&&t.children.sort(r)},v:function(t,n,i,r){t.children.sort(r);for(var e,o=this.toBBox,s=d(t,0,n,o),u=d(t,i-n,i,o),h=f(s)+f(u),a=n;a<i-n;a++)e=t.children[a],c(s,t.leaf?o(e):e),h+=f(s);for(a=i-n-1;n<=a;a--)e=t.children[a],c(u,t.leaf?o(e):e),h+=f(u);return h},c:function(t,n,i){for(var r=i;0<=r;r--)c(n[r],t)},u:function(t){for(var n,i=t.length-1;0<=i;i--)0===t[i].children.length?0<i?(n=t[i-1].children).splice(n.indexOf(t[i]),1):this.clear():v(t[i],this.toBBox)},i:function(t){var n=["return a"," - b",";"];this.compareMinX=new Function("a","b",n.join(t[0])),this.compareMinY=new Function("a","b",n.join(t[1])),this.toBBox=new Function("a","return {minX: a"+t[0]+", minY: a"+t[1]+", maxX: a"+t[2]+", maxY: a"+t[3]+"};")}},o.default=n;var n=Object.freeze({coordEach:b,coordReduce:M,propEach:g,propReduce:function(t,i,r){var e=r;return g(t,function(t,n){e=0===n&&void 0===r?t:i(e,t,n)}),e},featureEach:P,featureReduce:function(t,i,r){var e=r;return P(t,function(t,n){e=0===n&&void 0===r?t:i(e,t,n)}),e},coordAll:function(t){var n=[];return b(t,function(t){n.push(t)}),n},geomEach:x,geomReduce:function(t,r,e){var o=e;return x(t,function(t,n,i){o=0===n&&void 0===e?t:r(o,t,n,i)}),o},flattenEach:k,flattenReduce:function(t,r,e){var o=e;return k(t,function(t,n,i){o=0===n&&0===i&&void 0===e?t:r(o,t,n,i)}),o},segmentEach:r,segmentReduce:function(t,e,o){var s=o,u=!1;return r(t,function(t,n,i,r){s=!1===u&&void 0===o?t:e(s,t,n,i,r),u=!0}),s},feature:E,lineString:C,lineEach:F,lineReduce:function(t,r,e){var o=e;return F(t,function(t,n,i){o=0===n&&void 0===e?t:r(o,t,n,i)}),o}}),S=n.featureEach,A=n.coordEach;function L(t){var n=[t[0],t[1]],i=[t[0],t[3]],r=[t[2],t[3]];return{type:"Feature",bbox:t,properties:{},geometry:{type:"Polygon",coordinates:[[n,[t[2],t[1]],r,i,n]]}}}function _(t){var n=[1/0,1/0,-1/0,-1/0];return A(t,function(t){n[0]>t[0]&&(n[0]=t[0]),n[1]>t[1]&&(n[1]=t[1]),n[2]<t[0]&&(n[2]=t[0]),n[3]<t[1]&&(n[3]=t[1])}),n}n=function(n){var t;function i(t){t=n.call(this,t)||this;return t.tree=function(t){t=o(t);return t.insert=function(t){var n;return Array.isArray(t)?(t=L(n=t)).bbox=n:t.bbox=t.bbox||_(t),o.prototype.insert.call(this,t)},t.load=function(t){var i=[];return Array.isArray(t)?t.forEach(function(t){var n=L(t);n.bbox=t,i.push(n)}):S(t,function(t){t.bbox=t.bbox||_(t),i.push(t)}),o.prototype.load.call(this,i)},t.remove=function(t){var n;return Array.isArray(t)&&((t=L(n=t)).bbox=n),o.prototype.remove.call(this,t)},t.clear=function(){return o.prototype.clear.call(this)},t.search=function(t){return{type:"FeatureCollection",features:o.prototype.search.call(this,this.toBBox(t))}},t.collides=function(t){return o.prototype.collides.call(this,this.toBBox(t))},t.all=function(){return{type:"FeatureCollection",features:o.prototype.all.call(this)}},t.toJSON=function(){return o.prototype.toJSON.call(this)},t.fromJSON=function(t){return o.prototype.fromJSON.call(this,t)},t.toBBox=function(t){t=t.bbox||(Array.isArray(t)&&4===t.length?t:_(t));return{minX:t[0],minY:t[1],maxX:t[2],maxY:t[3]}},t}(),t}r=n,(t=i).prototype=Object.create(r.prototype),e(t.prototype.constructor=t,r);var r=i.prototype;return r.getMode=function(){if(this.d=this.d||this.options.mode,this.p(this.d))return this.d;throw new Error("snap mode is invalid")},r.setMode=function(t){if(!this.p(this.d))throw new Error("snap mode is invalid");var n;this.d=t,this.snaplayer&&(this.snaplayer instanceof Array?(this.allLayersGeometries=[],this.snaplayer.forEach(function(t,n){t=t.getGeometries();this.allLayersGeometries[n]=this.m(t)}.bind(this)),this.allGeometries=(n=[]).concat.apply(n,this.allLayersGeometries)):(n=this.snaplayer.getGeometries(),this.allGeometries=this.m(n)))},r.addTo=function(t){var n=u.INTERNAL_LAYER_PREFIX+"_snapto";this.w=new u.VectorLayer(n).addTo(t),this.M=t,this.allGeometries=[],this.enable()},r.remove=function(){this.disable(),this.w&&(this.w.remove(),delete this.w)},r.getMap=function(){return this.M},r.p=function(t){return"point"===t||"line"===t},r.enable=function(){var t,n=this.getMap();if(this.snaplayer&&(this.snaplayer instanceof Array?(this.allLayersGeometries=[],this.snaplayer.forEach(function(t,n){t=t.getGeometries();this.allLayersGeometries[n]=this.m(t)}.bind(this)),this.allGeometries=(t=[]).concat.apply(t,this.allLayersGeometries)):(t=this.snaplayer.getGeometries(),this.allGeometries=this.m(t))),!this.allGeometries)throw new Error("you should set geometries which are snapped to firstly!");this.g||this.b(n),this.w&&this.w.show()},r.disable=function(){var t=this.getMap();t.off("mousemove touchstart",this.g),t.off("mousedown",this.P,this),t.off("mouseup",this.k,this),this.w&&this.w.hide(),delete this.g,this.allGeometries=[]},r.setGeometries=function(t){t=t instanceof Array?t:[t],this.allGeometries=this.m(t)},r.setLayer=function(t){var n;t instanceof Array?(this.snaplayer=[],this.allLayersGeometries=[],t.forEach(function(t,n){var i;t instanceof u.VectorLayer&&(this.snaplayer.push(t),i=t.getGeometries(),this.allLayersGeometries[n]=this.m(i),t.on("addgeo",function(){var t=this.snaplayer[n].getGeometries();this.allLayersGeometries[n]=this.m(t),this.allGeometries=(t=[]).concat.apply(t,this.allLayersGeometries)},this),t.on("clear",function(){var t;this.allLayersGeometries.splice(n,1),this.allGeometries=(t=[]).concat.apply(t,this.allLayersGeometries)},this))}.bind(this)),this.allGeometries=(n=[]).concat.apply(n,this.allLayersGeometries),this.w.bringToFront()):t instanceof u.VectorLayer&&(n=t.getGeometries(),this.snaplayer=t,this.allGeometries=this.m(n),t.on("addgeo",function(){var t=this.snaplayer.getGeometries();this.allGeometries=this.m(t)},this),this.snaplayer.on("clear",function(){this.F()},this),this.w.bringToFront())},r.bindDrawTool=function(t){var s=this;t instanceof u.DrawTool&&(t.on("drawstart",function(t){s.snapPoint&&(s.S(t.target.L,s.snapPoint),s._(t.target.j,s.snapPoint))},this),t.on("mousemove",function(t){var n,i,r,e;s.snapPoint&&(r=t.target.getMode(),n=t.target.getMap(),"circle"===r||"freeHandCircle"===r?(i=n.computeLength(t.target.L.getCenter(),s.snapPoint),t.target.L.setRadius(i)):"ellipse"===r||"freeHandEllipse"===r?(e=t.target.L.getCenter(),i=n.computeLength(e,new u.Coordinate({x:s.snapPoint.x,y:e.y})),e=n.computeLength(e,new u.Coordinate({x:e.x,y:s.snapPoint.y})),t.target.L.setWidth(2*i),t.target.L.setHeight(2*e)):"rectangle"===r||"freeHandRectangle"===r?(e=n.coordToContainerPoint(new u.Coordinate({x:s.snapPoint.x,y:s.snapPoint.y})),e=[[(r=n.coordToContainerPoint(t.target.L.getFirstCoordinate())).x,r.y],[e.x,r.y],[e.x,e.y],[r.x,e.y]],t.target.L.setCoordinates(e.map(function(t){return n.containerPointToCoord(new u.Point(t))}))):s.S(t.target.L,s.snapPoint))},this),t.on("drawvertex",function(t){s.snapPoint&&(s.S(t.target.L,s.snapPoint),s._(t.target.j,s.snapPoint))},this),t.on("drawend",function(t){var n,i,r,e,o;s.snapPoint&&(e=t.target.getMode(),n=t.target.getMap(),i=t.geometry,"circle"===e||"freeHandCircle"===e?(r=n.computeLength(t.target.L.getCenter(),s.snapPoint),i.setRadius(r)):"ellipse"===e||"freeHandEllipse"===e?(o=i.getCenter(),r=n.computeLength(o,new u.Coordinate({x:s.snapPoint.x,y:o.y})),o=n.computeLength(o,new u.Coordinate({x:o.x,y:s.snapPoint.y})),i.setWidth(2*r),i.setHeight(2*o)):"rectangle"===e||"freeHandRectangle"===e?(o=n.coordToContainerPoint(new u.Coordinate({x:s.snapPoint.x,y:s.snapPoint.y})),o=[[(e=n.coordToContainerPoint(i.getFirstCoordinate())).x,e.y],[o.x,e.y],[o.x,o.y],[e.x,o.y]],i.setCoordinates(o.map(function(t){return n.containerPointToCoord(new u.Point(t))}))):s.S(i,s.snapPoint))},this))},r.S=function(t,n){if(!t)return t;var i=t.getCoordinates();if(t instanceof u.Polygon){if(t instanceof u.Circle)return t;var r=i[0];r instanceof Array&&2<r.length&&(r[r.length-2].x=n.x,r[r.length-2].y=n.y)}else i instanceof Array?(i[i.length-1].x=n.x,i[i.length-1].y=n.y):i instanceof u.Coordinate&&(i.x=n.x,i.y=n.y);return t.setCoordinates(i),t},r._=function(t,n){t&&(t[t.length-1].x=n.x,t[t.length-1].y=n.y)},r.R=function(t){t=t instanceof Array?t:[t];t=this.m(t);this.allGeometries=this.allGeometries.concat(t)},r.F=function(){this.addGeometries=[]},r.O=function(t){if(this.allGeometries){var n=this.allGeometries;return this.tree.clear(),this.tree.load({type:"FeatureCollection",features:n}),this.inspectExtent=this.G(t),this.tree.search(this.inspectExtent)}return null},r.m=function(t){var n=[],i=this.getMode();return"point"===i?n=this.H(t):"line"===i&&(n=this.X(t)),n},r.H=function(t){var n=[];return t.forEach(function(t){n=n.concat(this.Y(t))}.bind(this)),n},r.N=function(t){var n=[];return t.forEach(function(t){t instanceof Array?t.forEach(function(t){t=(t=new u.Marker(t,{properties:{}})).toGeoJSON();n.push(t)}):(t=(t=new u.Marker(t,{properties:{}})).toGeoJSON(),n.push(t))}),n},r.Y=function(t){var n=t.getType(),i=null,i="Circle"===n||"Ellipse"===n?t.getShell():t.getCoordinates(),r=[];return i[0]instanceof Array?i.forEach(function(t){t=this.N(t);r=r.concat(t)}.bind(this)):(i instanceof Array||(i=[i]),i=this.N(i),r=r.concat(i)),r},r.X=function(t){var i=[];return t.forEach(function(t){switch(t.getType()){case"Point":var n=t.toGeoJSON();n.properties={},i.push(n);break;case"LineString":case"Polygon":i=i.concat(this.T(t,1))}}.bind(this)),i},r.T=function(n,i){var t=n.getCoordinates(),r=[];return t[0]instanceof Array?t.forEach(function(t){t=this.q(t,i,n);r=r.concat(t)}.bind(this)):(t=this.q(t,i,n),r=r.concat(t)),r},r.q=function(t,n,i){for(var r=[],e=t.length-n,o=0;o<e;o++){var s=new u.LineString([t[o],t[o+1]],{properties:{obj:i}});r.push(s.toGeoJSON())}return r},r.G=function(t){var n=this.options.tolerance||10,i=this.getMap(),r=i.getZoom(),e=i.coordinateToPoint(t,r),o=i.pointToCoordinate(new u.Point([e.x-n,e.y-n]),r),s=i.pointToCoordinate(new u.Point([e.x+n,e.y-n]),r),t=i.pointToCoordinate(new u.Point([e.x-n,e.y+n]),r),r=i.pointToCoordinate(new u.Point([e.x+n,e.y+n]),r);return{type:"Feature",properties:{},geometry:{type:"Polygon",coordinates:[[[o.x,o.y],[s.x,s.y],[r.x,r.y],[t.x,t.y]]]}}},r.b=function(t){this.J=!0,this.g=function(t){this.mousePoint=t.coordinate,this.U?this.U.setCoordinates(t.coordinate):this.U=new u.Marker(t.coordinate,{symbol:this.options.symbol}).addTo(this.w),this.J&&(0<(t=this.W(t.coordinate)).features.length?(this.snapPoint=this.D(t),this.snapPoint&&this.U.setCoordinates([this.snapPoint.x,this.snapPoint.y])):this.snapPoint=null)},this.P=function(){this.J=!1},this.k=function(){this.J=!0},t.on("mousemove touchstart",this.g,this),t.on("mousedown",this.P,this),t.on("mouseup",this.k,this)},r.I=function(t){for(var n=[],i=0;i<t.length;i++){var r,e=t[i];"LineString"===e.geometry.type?(r=this.z(this.mousePoint,e),n.push({geoObject:e,distance:r})):"Point"===e.geometry.type&&(r=this.K(this.mousePoint,e),n.push({geoObject:e,distance:r}))}return n},r.Q=function(t){var t=this.I(t);return(t=t.sort(this.V(t,"distance")))[0]},r.W=function(t){return this.O(t)},r.D=function(t){var n=this.Q(t.features),i=null;return this.Z(n.distance)?("Point"===n.geoObject.geometry.type?i={x:n.geoObject.geometry.coordinates[0],y:n.geoObject.geometry.coordinates[1]}:"LineString"===n.geoObject.geometry.type&&(i=0===(t=this.$(n.geoObject)).A?{x:this.mousePoint.x,y:n.geoObject.geometry.coordinates[0][1]}:t.A===1/0?{x:n.geoObject.geometry.coordinates[0][0],y:this.mousePoint.y}:(n=t.B/t.A,n=this.tt(n,this.mousePoint),this.nt(t,n))),i):null},r.z=function(t,n){var i=this.$(n),r=i.A,n=i.B,i=i.C;return Math.abs((r*t.x+n*t.y+i)/Math.sqrt(Math.pow(r,2)+Math.pow(n,2)))},r.Z=function(t){var n=this.getMap().getResolution();return!(this.options.tolerance<t/n)},r.K=function(t,n){t=[t.x,t.y],n=n.geometry.coordinates;return Math.sqrt(Math.pow(t[0]-n[0],2)+Math.pow(t[1]-n[1],2))},r.$=function(t){var n=t.geometry.coordinates,t=n[0],n=n[1],n=Number((t[1]-n[1])/(t[0]-n[0]).toString());return{A:n,B:-1,C:t[1]-n*t[0]}},r.tt=function(t,n){return{A:t,B:-1,C:n.y-t*n.x}},r.nt=function(t,n){var i=t.A,r=t.B,e=t.C,o=n.A,t=n.B,n=n.C;return{x:(r*n-e*t)/(i*t-o*r),y:(i*n-o*e)/(r*o-t*i)}},r.V=function(t,i){return function(t,n){t=t[i],n=n[i];return n<t?1:t<n?-1:0}},i}(u.Class);n.mergeOptions({mode:"line",tolerance:10,symbol:{markerType:"ellipse",markerFill:"#0f89f5",markerLineColor:"#fff",markerLineWidth:2,markerLineOpacity:1,markerWidth:15,markerHeight:15}}),t.SnapTool=n,Object.defineProperty(t,"it",{value:!0})});
